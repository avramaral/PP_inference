<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="André V. Ribeiro Amaral">

<title>Inference in Point Processes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#point-process" id="toc-point-process" class="nav-link active" data-scroll-target="#point-process">Point process</a></li>
  <li><a href="#intensity" id="toc-intensity" class="nav-link" data-scroll-target="#intensity">Intensity</a></li>
  <li><a href="#poisson-point-process" id="toc-poisson-point-process" class="nav-link" data-scroll-target="#poisson-point-process">Poisson Point Process</a>
  <ul class="collapse">
  <li><a href="#homogeneous-poisson-process" id="toc-homogeneous-poisson-process" class="nav-link" data-scroll-target="#homogeneous-poisson-process">Homogeneous Poisson process</a></li>
  <li><a href="#non-homogeneous-poisson-process" id="toc-non-homogeneous-poisson-process" class="nav-link" data-scroll-target="#non-homogeneous-poisson-process">Non-homogeneous Poisson process</a></li>
  </ul></li>
  <li><a href="#likelihood-function" id="toc-likelihood-function" class="nav-link" data-scroll-target="#likelihood-function">Likelihood function</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  </ul></li>
  <li><a href="#hypothesis-test" id="toc-hypothesis-test" class="nav-link" data-scroll-target="#hypothesis-test">hypothesis test</a></li>
  <li><a href="#cox-process" id="toc-cox-process" class="nav-link" data-scroll-target="#cox-process">Cox Process</a></li>
  <li><a href="#inla-and-r-inla" id="toc-inla-and-r-inla" class="nav-link" data-scroll-target="#inla-and-r-inla">INLA and <code>R-INLA</code></a>
  <ul class="collapse">
  <li><a href="#fitting-a-lgcp-with-r-inla" id="toc-fitting-a-lgcp-with-r-inla" class="nav-link" data-scroll-target="#fitting-a-lgcp-with-r-inla">Fitting a LGCP with <code>R-INLA</code></a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Inference in Point Processes</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>André V. Ribeiro Amaral </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>In this tutorial, we will use the following <code>R</code> packages.</p>
<div class="cell" data-result="hide">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spatstat"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"inlabru"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tmap"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"raster"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"rgeos"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"INLA"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="point-process" class="level2">
<h2 class="anchored" data-anchor-id="point-process">Point process</h2>
<blockquote class="blockquote">
<p>Let <span class="math inline">x \in \mathcal{D} \subseteq \mathbb{R}^n</span>, <span class="math inline">n \in \{1, 2, \cdots\}</span>, such that <span class="math inline">\mathcal{D}</span> is the domain. Then, a <strong>point process</strong> <span class="math inline">\xi</span> is defined as a locally finite random subset of <span class="math inline">\mathcal{D}</span>; that is, <span class="math inline">\mathcal{N}(D) := \#(\xi \cap \text{D})</span> is finite for all bounded subsets <span class="math inline">\text{D} \subseteq \mathcal{D}</span>, where <span class="math inline">\#(\text{A})</span> denotes de cardinality of <span class="math inline">\text{A}</span>.</p>
</blockquote>
<p>As a note, a <strong>point process</strong> is random mechanism whose outcome is a <strong>point pattern</strong>.</p>
</section>
<section id="intensity" class="level2">
<h2 class="anchored" data-anchor-id="intensity">Intensity</h2>
<p>For a point process, we may define an <strong>intensity function</strong> as follows</p>
<blockquote class="blockquote">
<p>Let <span class="math inline">\lambda: \mathcal{D} \rightarrow [0, +\infty)</span>, such that <span class="math inline">\int_{D}\lambda(x)dx &lt; +\infty</span>, for all bounded <span class="math inline">\text{D} \subseteq \mathcal{D}</span>. <span class="math inline">\lambda(x)</span> is the <strong>intensity function</strong> of a point process <span class="math inline">\xi</span>, if <span class="math display">\mathbb{E}[\mathcal{N}(D)] = \int_{\text{D}}\lambda(x)dx, ~ \text{D} \subseteq \mathcal{D}.</span></p>
</blockquote>
<p>If <span class="math inline">\lambda(x) = \lambda</span>, <span class="math inline">\forall x</span>, that is, if it is a constant function, notice that <span class="math inline">\mathbb{E}[\mathcal{N}(D)] = \lambda \cdot |\text{D}|</span>. In that case, <strong><span class="math inline">\lambda</span> denotes the average number of points per unit area</strong>.</p>
<p>Also, the intensity function is closely related to the probability density.</p>
<blockquote class="blockquote">
<p>If <span class="math inline">\xi</span> is a point process with intensity function <span class="math inline">\lambda(x)</span> defined on <span class="math inline">\mathcal{D}</span>, then each individual point inside <span class="math inline">\mathcal{D}</span> has probability density <span class="math display">f(x) = \frac{\lambda(x)}{\Lambda_{\mathcal{D}}},</span> where <span class="math display">\Lambda_{\mathcal{D}} = \int_{\mathcal{D}}\lambda(x)dx.</span></p>
</blockquote>
<p>Using <code>spatstat</code> we can generate a point pattern containing <span class="math inline">n</span> independent, identically distributed random points with intensity <span class="math inline">f</span> using the <code>rpoint()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span> (x, y) { (x <span class="sc">**</span> <span class="dv">2</span> <span class="sc">+</span> y <span class="sc">**</span> <span class="dv">2</span>) }</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.05</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">outer</span>(<span class="at">X =</span> x, <span class="at">Y =</span> y, <span class="at">FUN =</span> f)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">owin</span>(<span class="at">xrange =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">yrange =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="co"># Area: (2 units x 2 units)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">rpoint</span>(<span class="at">n =</span> <span class="dv">200</span>, <span class="at">f =</span> f, <span class="at">win =</span> w)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">persp</span>(x, y, z, <span class="at">theta =</span> <span class="dv">30</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pp, <span class="at">main =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="poisson-point-process" class="level2">
<h2 class="anchored" data-anchor-id="poisson-point-process">Poisson Point Process</h2>
<blockquote class="blockquote">
<p>A point process <span class="math inline">\xi</span> defined on <span class="math inline">\mathcal{D}</span> is a <strong>Poisson point process</strong> with intensity function <span class="math inline">\lambda(x)</span> if the following properties are satisfied</p>
<ol type="1">
<li><p>For any bounded <span class="math inline">\text{D} \subseteq \mathcal{D}</span>, <span class="math inline">\mathcal{N}(\text{D}) \sim \text{Poisson}(\int_{\text{D}}\lambda(x)dx)</span>.</p></li>
<li><p>For any bounded <span class="math inline">\text{D} \subseteq \mathcal{D}</span> and <span class="math inline">n \in \mathbb{N}</span>, conditional on <span class="math inline">\mathcal{N}(\text{D}) = n</span>, the events <span class="math inline">\xi \cap \text{D}</span> are independent with intensity proportional to <span class="math inline">\lambda(x)</span>.</p></li>
</ol>
</blockquote>
<p>As a note, it <span class="math inline">\lambda(x) = \lambda</span>, <span class="math inline">\forall x</span>, then <span class="math inline">\xi</span> is a <strong>homogeneous Poisson process</strong>; otherwise, it is a <strong>non-homogeneous Poisson process</strong>.</p>
<section id="homogeneous-poisson-process" class="level3">
<h3 class="anchored" data-anchor-id="homogeneous-poisson-process">Homogeneous Poisson process</h3>
<p>We can manually simulate a homogeneous Poisson process as follows</p>
<ol type="1">
<li>Determine <span class="math inline">\mathcal{N}(D)</span>, for some <span class="math inline">D \subseteq \mathcal{D}</span>.</li>
<li>Simulate the number of events <span class="math inline">n</span> from a Poisson(<span class="math inline">\lambda\cdot|D|</span>).</li>
<li>Obtain the location of the <span class="math inline">n</span> events by simulating from an uniform distribution.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sim.HPP <span class="ot">&lt;-</span> <span class="cf">function</span> (lambda, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, ...) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> lambda <span class="sc">*</span> (max <span class="sc">-</span> min)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> m)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="fu">runif</span>(N, <span class="at">min =</span> min, <span class="at">max =</span> max))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>hpp <span class="ot">&lt;-</span> <span class="fu">sim.HPP</span>(<span class="at">lambda =</span> <span class="fl">0.5</span>, <span class="at">max =</span> <span class="dv">100</span>, <span class="at">min =</span> <span class="dv">0</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hpp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.3535495  0.5396310  5.5676715 10.3492299 11.1476796 14.4515851
 [7] 14.9180392 15.9673980 17.4775137 19.1189961 19.6719169 19.9752943
[13] 22.1834201 22.2928340 24.2387337 25.0736451 26.7346206 32.7452220
[19] 41.6347296 43.4830146 43.5288069 43.8059504 44.7422891 49.2827306
[25] 51.4434260 57.4189733 57.7254297 57.7635149 58.9999127 59.8600273
[31] 60.8599697 61.2403756 61.6342769 68.0476603 72.9181244 73.6506027
[37] 74.4836050 75.3390585 76.2458188 81.5512829 85.0963224 90.6697583
[43] 91.9029311 95.1212361 95.9875866 99.2158440 99.7424144 99.7688745</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(hpp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 48</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1D PP</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plot1D.pp <span class="ot">&lt;-</span> <span class="cf">function</span> (pp, <span class="at">xlim =</span> <span class="cn">NA</span>, ...) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(xlim)) { xlim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">floor</span>(<span class="fu">min</span>(pp)), <span class="fu">ceiling</span>(<span class="fu">max</span>(pp))) }</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">x =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xlim =</span> xlim, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">asp =</span> <span class="fu">diff</span>(xlim) <span class="sc">*</span> <span class="fl">0.1</span>) </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrows</span>(<span class="at">x0 =</span> pp, <span class="at">y0 =</span> <span class="dv">1</span>, <span class="at">x1 =</span> pp, <span class="at">y1 =</span> <span class="dv">0</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">pos =</span> <span class="dv">0</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot1D.pp</span>(hpp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An unbiased estimator for <span class="math inline">\lambda</span> in a homogeneous Poisson process is <span class="math display">\hat{\lambda} = \frac{\#(x)}{|D|},</span> where <span class="math inline">\mathbf{x}</span> is the point pattern data set, and <span class="math inline">D</span> is the observed in a window.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(lambda_hat <span class="ot">&lt;-</span> <span class="fu">length</span>(pp) <span class="sc">/</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05</code></pre>
</div>
</div>
</section>
<section id="non-homogeneous-poisson-process" class="level3">
<h3 class="anchored" data-anchor-id="non-homogeneous-poisson-process">Non-homogeneous Poisson process</h3>
<p>To simulate from a non-homogeneous Poisson process, we can use the thinning (<a href="https://onlinelibrary.wiley.com/doi/10.1002/nav.3800260304">Lewis and Shedler, 1979</a>).</p>
<ol type="1">
<li>Find <span class="math inline">\max(\lambda(x))</span>, i.e., the maximum of <span class="math inline">\lambda(x)</span> in <span class="math inline">\mathcal{D}</span>.</li>
<li>Simulate a homogeneous Poisson process with <span class="math inline">\lambda = \max(\lambda(x) \cdot |D|)</span>.</li>
<li>Accept each event with probability <span class="math inline">\lambda(x_i)/\max(\lambda(x))</span>.</li>
</ol>
<p>For example, let <span class="math inline">\lambda(x) = \exp(\beta_0 + \beta_1 \cdot x)</span>, such that <span class="math inline">\beta_0 = -1</span> and <span class="math inline">\beta_1 = 0.015</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="cf">function</span>(x, par, <span class="at">log =</span> <span class="cn">FALSE</span>, ...) { </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> par[<span class="dv">1</span>] <span class="sc">+</span> par[<span class="dv">2</span>] <span class="sc">*</span> x</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log) { res <span class="ot">&lt;-</span> eta } <span class="cf">else</span> { res <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta) }</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="fl">0.1</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">0.015</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> pts, <span class="at">y =</span> <span class="fu">l</span>(pts, par), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"x"</span>, <span class="at">ylab =</span> <span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In that case, <span class="math inline">\mathbb{E}[\mathcal{N}(D)] = 85</span>, such that <span class="math inline">D = [0, 100]</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate</span>(l, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">100</span>, <span class="at">par =</span> par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>85.38946 with absolute error &lt; 9.5e-13</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sim.NHPP <span class="ot">&lt;-</span> <span class="cf">function</span> (par, FUN, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, ...) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  max_lb <span class="ot">&lt;-</span> <span class="fu">optimize</span>(FUN, <span class="fu">c</span>(min, max), <span class="at">par =</span> par, <span class="at">maximum =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>objective</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> max_lb <span class="sc">*</span> (max <span class="sc">-</span> min)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># As in `sim.IPP()`</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> lambda)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(N, <span class="at">min =</span> min, <span class="at">max =</span> max))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Accept or reject</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  p.accept <span class="ot">&lt;-</span> <span class="fu">FUN</span>(pts, par) <span class="sc">/</span> max_lb</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  pp <span class="ot">&lt;-</span> pts[<span class="fu">runif</span>(<span class="fu">length</span>(pts)) <span class="sc">&lt;=</span> p.accept]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributes</span>(pp) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">simulated =</span> <span class="fu">length</span>(pts), <span class="at">accepted =</span> <span class="fu">length</span>(pp), <span class="at">rate =</span> <span class="fu">length</span>(pp) <span class="sc">/</span> <span class="fu">length</span>(pts))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  pp</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>nhpp <span class="ot">&lt;-</span> <span class="fu">sim.NHPP</span>(<span class="at">par =</span> par, <span class="at">FUN =</span> l, <span class="at">max =</span> <span class="dv">100</span>, <span class="at">min =</span> <span class="dv">0</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">unlist</span>(<span class="fu">attributes</span>(nhpp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  simulated    accepted        rate 
143.0000000  84.0000000   0.5874126 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot1D.pp</span>(nhpp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="likelihood-function" class="level2">
<h2 class="anchored" data-anchor-id="likelihood-function">Likelihood function</h2>
<p>The likelihood function of a point process is obtained based on the density function of the two observed variables, namely the number of events <span class="math inline">\mathcal{N}</span> and the locations <span class="math inline">\{x\}</span>.</p>
<p>For a Poisson process, we have that <span class="math inline">\mathcal{N}(D) \sim \text{Poisson}(\int_D\lambda(x)dx)</span> and, for each <span class="math inline">x</span>, $(x_i) = (x_i) / . Therefore, <span class="math display">\begin{align*}
L(\theta) &amp;= \frac{e^{-(\int_D\lambda(x)dx)}(\int_D\lambda(x)dx)^N}{N!} \prod_{i = 1}^N \frac{\lambda(x_i)}{\int_D\lambda(x)dx} \\ &amp;\propto e^{-(\int_D\lambda(x)dx)}\prod_{i = 1}^N\lambda(x_i),
\end{align*}</span> where <span class="math inline">N</span> is a a realization of <span class="math inline">\mathcal{N}(D)</span>. The log-likelihood is given by <span class="math display">\begin{align*}
\ell(\theta) \propto \sum_{i = 1}^{N}\log(\lambda(x_i)) - \int_D\lambda(x)dx.
\end{align*}</span></p>
<p>For a homogeneous Poisson process, <span class="math display">\begin{align*}
\ell(\lambda) &amp;\propto N \log(\lambda) - \lambda\cdot|D| \\
\hat{\lambda} &amp;= \frac{N(D)}{|D|}.
\end{align*}</span></p>
<p>However, for a non-homogeneous Poisson process, the MLE for will depend of the form of <span class="math inline">\lambda(x)</span>. In our previous example <span class="math display">\begin{align*}
  \ell(\beta_0 + \beta_1) \propto \sum_{i = 1}^N\log(\beta_0 + \beta_1x_i) - \int_D\beta_0 + \beta_1x dx.
\end{align*}</span> Although, in some cases it is possible to have a closed-form solution for <span class="math inline">(\hat{\beta}_0, \hat{\beta}_1)^{\top}</span>, let us compute them numerically.</p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>Let us implement the log-likelihood function as before</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lik.NHPP <span class="ot">&lt;-</span> <span class="cf">function</span> (par, FUN, pp, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, ...) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  int.l <span class="ot">&lt;-</span> <span class="fu">integrate</span>(FUN, <span class="at">low =</span> min, <span class="at">upp =</span> max, <span class="at">par =</span> par)<span class="sc">$</span>value</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  sum.t <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">FUN</span>(<span class="at">x =</span> pp, <span class="at">par =</span> par, <span class="at">log =</span> T))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>(sum.t <span class="sc">-</span> int.l)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>initial_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>(theta_hat <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> initial_values, <span class="at">fn =</span> lik.NHPP, <span class="at">FUN =</span> l, <span class="at">pp =</span> nhpp, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] -1.0336698  0.0152766

$value
[1] 90.92931</code></pre>
</div>
</div>
</section>
</section>
<section id="hypothesis-test" class="level2">
<h2 class="anchored" data-anchor-id="hypothesis-test">hypothesis test</h2>
<p>We can visually inspect whether the point pattern seemed to be sampled from a (non-)homogeneous process by counting the number of events by interval.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>L  <span class="ot">&lt;-</span> <span class="fu">psp</span>(<span class="at">x0 =</span> <span class="dv">0</span>, <span class="at">y0 =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">100</span>, <span class="at">y1 =</span> <span class="dv">0</span>, <span class="fu">owin</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>)))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">as.ppp</span>(<span class="fu">cbind</span>(<span class="fu">c</span>(nhpp), <span class="dv">0</span>), <span class="at">W =</span> L)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">quadratcount</span>(<span class="at">X =</span> pp, <span class="at">nx =</span> <span class="dv">8</span>, <span class="at">ny =</span> <span class="dv">1</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(q, <span class="at">main =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Alternatively, we can conduct a hypothesis test. In particular, we test the null hypothesis that the data pattern is a realization of Complete Spatial Randomness”; i.e., uniform Poisson point process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">quadrat.test</span>(<span class="at">X =</span> pp, <span class="at">nx =</span> <span class="dv">8</span>, <span class="at">ny =</span> <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Chi-squared test of CSR using quadrat counts

data:  pp
X2 = 22.286, df = 7, p-value = 0.004535
alternative hypothesis: two.sided

Quadrats: 8 by 1 grid of tiles</code></pre>
</div>
</div>
<p>In the case of <code>nhpp</code> (known to be a realization from non-homogeneous process), at a 5% confidence level, we <strong>reject</strong> the null hypothesis data pattern is a realization of “Complete Spatial Randomness”.</p>
</section>
<section id="cox-process" class="level2">
<h2 class="anchored" data-anchor-id="cox-process">Cox Process</h2>
<p>As a generalization of a Poisson process, we can define a <strong>Cox process</strong>. In a nutshell, a Cox process allows the modelling of the non-observable spatial heterogeneity.</p>
<blockquote class="blockquote">
<p>A Cox process can be seen as a doubly stochastic process. <span class="math inline">\xi</span> is a Cox process driven by <span class="math inline">\Lambda(x)</span> if</p>
<ol type="1">
<li><p><span class="math inline">\{\Lambda(x); x \in \mathcal{D}\}</span> is a non-negative valued stochastic process.</p></li>
<li><p>Conditional on <span class="math inline">\{\Lambda(x) = \lambda(x); \mathbf{x} \in \mathcal{D}\}</span>, <span class="math inline">\xi</span> is a Poisson process with intensity function <span class="math inline">\lambda(x)</span>.</p></li>
</ol>
</blockquote>
<p>A particular case of a Cox process, named <strong>log-Gaussian Cox process</strong>, can be constructed by setting <span class="math inline">\log\{\Lambda(x)\} = \mu^{\star}(x) + \zeta(x)</span>, such that <span class="math inline">\mu(x) = \exp\{\mu^{\star}(x)\}</span> is possibly interpreted as the mean structure of <span class="math inline">\Lambda(x)</span>, and <span class="math inline">\zeta(x)</span> is a stationary Gaussian process, such that <span class="math inline">\mathbb{E}(\zeta(x)) = -\sigma^2/2</span>, <span class="math inline">\forall x</span>, and <span class="math inline">\text{Cov}(\zeta(x_1), \zeta(x_2)) = \phi(h) = \sigma^2 \rho(h)</span>, where <span class="math inline">h = ||x_1 - x_2||</span> and <span class="math inline">\sigma^2</span> is the variance of <span class="math inline">\zeta(x)</span> .</p>
<p>For instance, the correlation structure can be set as a Matérn model, that is, <span class="math display">
\rho(h) = \frac{1}{2^{\nu - 1}\Gamma(\nu)}(\kappa \cdot h)^{\nu} \,\text{K}_{\nu}(\kappa \cdot h),
</span> such that <span class="math inline">\nu</span> and <span class="math inline">\kappa</span> are unknown parameters, and <span class="math inline">\text{K}_{\nu}(\cdot)</span> is a modified Bessel function of <span class="math inline">2^{\text{nd}}</span> order.</p>
</section>
<section id="inla-and-r-inla" class="level2">
<h2 class="anchored" data-anchor-id="inla-and-r-inla">INLA and <code>R-INLA</code></h2>
<p>To fit a LGCP model, we will use the Integrated Nested Laplace Approximation, INLA (<a href="https://rss.onlinelibrary.wiley.com/doi/10.1111/j.1467-9868.2008.00700.x">Rue et al., 2009</a>), implemented in the <code>R-INLA</code> package.</p>
<p>In a nutshell, INLA is a method for approximating Bayesian inference in latent Gaussian models. In particular, it can be used to fit models of the form <span class="math display">\begin{align*}
    y_i|S(x_i), &amp;\theta \sim \pi(y_i|S(x_i), \theta), \text{ for } i \in \{1, \cdots, n\} \\
    S(x)|\theta &amp;\sim \text{Normal}(\mu(\theta), Q(\theta)^{-1}) \\
    \theta &amp;\sim \pi(\theta),
\end{align*}</span> where <span class="math inline">y = (y_1, \ldots, y_n)</span> is the vector or observed values, <span class="math inline">x = (x_1, \ldots, x_n)</span> is a Gaussian random field, and <span class="math inline">\theta = (\theta_1, \ldots, \theta_k)</span>, for some <span class="math inline">k \in \mathbb{N}</span>, is a vector of hyperparameters. <span class="math inline">\mu(\theta)</span> and <span class="math inline">Q(\theta)</span> represent the mean vector and the precision matrix, respectively.</p>
<section id="fitting-a-lgcp-with-r-inla" class="level3">
<h3 class="anchored" data-anchor-id="fitting-a-lgcp-with-r-inla">Fitting a LGCP with <code>R-INLA</code></h3>
<p>Although we can use a Stochastic Partial Differential Equation (SPDE)-approach to fit LGCP models using INLA (<a href="https://arxiv.org/abs/1111.0641">Simpson et al., 2016</a>), we will consider a partition of <span class="math inline">\mathcal{D}</span> given by cells <span class="math inline">c_{i, j}</span>, for some set of index <span class="math inline">(i, j)</span>.</p>
<p>First, recall that if <span class="math inline">\xi</span> is a LGCP, then the mean number of events in a cell <span class="math inline">c_{ij}</span> is given by the integral of the intensity over the cell, that is, <span class="math inline">\int_{c_{i,j}}\exp\{\zeta(x)\}dx</span>. Then, for sufficiently small cells, such an integral can be approximated by <span class="math inline">|c_{i,j}|\exp\{\zeta(x)\}</span>, where <span class="math inline">|c_{i, j}|</span> is the area of the cell <span class="math inline">c_{i, j}</span>.</p>
<p>Thus, conditional on the latent Gaussian field <span class="math inline">\zeta(x)</span>, the number of locations in the grid cell <span class="math inline">c_{i, j}</span>, <span class="math inline">\forall i, j</span>, are independent and Poisson distributed as follows <span class="math display">
\mathcal{N}(c_{ij})|\zeta(x) \sim \text{Poisson}(|c_{i, j}| \cdot \exp\{\zeta(x)\}),
</span> where <span class="math inline">\zeta(x)</span> is a Gaussian field.</p>
<section id="example-1" class="level4">
<h4 class="anchored" data-anchor-id="example-1">Example 1</h4>
<p>For the first example, we will analyze the spatial locations of cases of lung cancer in <code>chorley</code> (from <code>spatstat.data</code>). The data give the precise domicile addresses of new cases of cancer of the larynx (58 cases) and cancer of the lung (978 cases), recorded in the Chorley and South Ribble Health Authority of Lancashire (England) between 1974 and 1983.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chorley)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern: 1036 points
Multitype, with levels = larynx, lung 
window: polygonal boundary
enclosing rectangle: [343.45, 366.45] x [410.41, 431.79] km</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chorley, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)), <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.75</span>, <span class="at">main =</span> <span class="st">"Cancer cases"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lung <span class="ot">&lt;-</span> chorley[chorley<span class="sc">$</span>marks <span class="sc">==</span> <span class="st">"lung"</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>lung <span class="ot">&lt;-</span> <span class="fu">ppp</span>(<span class="at">x =</span> lung<span class="sc">$</span>x, <span class="at">y =</span> lung<span class="sc">$</span>y, <span class="at">window =</span> lung<span class="sc">$</span>window)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lung, <span class="at">cols =</span> <span class="st">"green"</span>, <span class="at">pch =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.75</span>, <span class="at">main =</span> <span class="st">"Lung-cancer cases"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let us start by creating a grid based study area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>resolution <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">st_as_sf</span>(lung<span class="sc">$</span>window), <span class="st">"Spatial"</span>) <span class="co"># Convert it to a `SpatialPolygonsDataFrame` object</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>map<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="st">"lung"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">raster</span>(map, <span class="at">resolution =</span> resolution) <span class="co"># Create a `raster` object based on the map and resolution</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(n_row <span class="ot">&lt;-</span> <span class="fu">nrow</span>(r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 43</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(n_col <span class="ot">&lt;-</span> <span class="fu">ncol</span>(r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 46</code></pre>
</div>
</div>
<p>Now, we have to count the number of observations within all cells and save it on the <code>r</code> object. To do so, we can create a <code>SpatialPoints</code> object based on the observations locations and use the <code>cellFromXY()</code> to count the number of points in each cell.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>r[] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># Set all `NA` to `0`</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dpts <span class="ot">&lt;-</span> <span class="fu">SpatialPoints</span>(<span class="fu">cbind</span>(<span class="fu">rev</span>(lung<span class="sc">$</span>x), <span class="fu">rev</span>(lung<span class="sc">$</span>y))) <span class="co"># Convert the locations to a `SpatialPoints` object</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>(tab <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">cellFromXY</span>(r, dpts))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 128  176  247  248  292  293  294  301  307  337  338  339  341  342  343  347 
   1    1    2    1    4    9    5    3    1    4    3   12    2    9    1    5 
 348  349  383  384  385  386  387  388  389  393  397  398  399  400  404  426 
   2    2    6    6    6    5    2    6    3   13    5    2    2    7    1    3 
 427  432  433  434  435  439  440  441  444  445  446  448  453  470  472  473 
   3    2   11   13    4    8    7    5    3    4    3    1    2    3    2    2 
 478  479  480  481  482  484  485  486  487  488  491  492  493  514  515  516 
   2    8    1    1    1    1    3    8    7    2    1    2    1    1    1    5 
 517  518  521  522  527  528  529  530  531  532  533  535  537  538  539  561 
   3    1    2    1    2    7    7    2    2   14    7    2    1    1    1    3 
 564  566  567  568  570  574  575  578  579  606  607  613  614  621  624  625 
   2    1    4    1    2    2    8    2    6    2    3    3    6    1    2    1 
 654  656  668  673  676  699  700  701  744  745  749  753  754  760  761  765 
   2    1    1    2    2    3    2    1    1    1    1    1    1    2    3    2 
 767  790  802  803  805  806  811  818  835  844  847  848  849  850  851  852 
   1    2    1    3    6   11    3    1    2    1    1   13   10    6   11    1 
 853  857  860  863  868  870  891  892  893  894  895  896  897  898  899  903 
   4    1    1    2    1    2    2    9   10    3    5    8   11   11    1    1 
 904  911  937  938  939  940  941  942  943  944  950  954  958  959  975  982 
   8    1    5    3    4    9    4    4    1    5    4    2    1    6    1    1 
 985  986  995  996  999 1004 1022 1042 1043 1044 1046 1073 1080 1083 1088 1091 
   3    1    2    1    1    1    1    1    1    1    2    1    3    1    2    1 
1128 1129 1134 1136 1161 1162 1166 1174 1175 1179 1180 1181 1182 1183 1184 1206 
   5    1    3    1    2    1    1    3    2    1    3    1    1    2    1    1 
1207 1208 1212 1217 1221 1222 1226 1227 1228 1266 1269 1271 1272 1273 1274 1304 
   3    1    1    1    4    6    5    6   10    2    2    2    9    7   11    2 
1306 1311 1317 1318 1319 1320 1321 1351 1352 1362 1363 1364 1365 1366 1367 1397 
   3    1    4   14    5   19    2    2    7    2    9   19    7   13    2    1 
1398 1399 1402 1408 1409 1410 1411 1412 1446 1450 1454 1455 1456 1457 1498 1499 
   2    3    1    2   12   19    6    2    1    1    3    8    5    4    2    2 
1502 1538 1544 1584 1588 1590 1591 1592 1599 1600 1635 1636 1637 1642 1643 1644 
   1    1    1    1    2    3    7    1    1    1    2    8    4    1    1    5 
1645 1646 1683 1685 1686 1687 1690 1691 1692 1728 1735 1736 1772 1782 
   3    6    1    1    1    1    6    5    1    1   10    7    2    2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>r[<span class="fu">as.numeric</span>(<span class="fu">names</span>(tab))] <span class="ot">&lt;-</span> tab <span class="co"># Assign the number of observed events to the `raster` object</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, we can create a <code>grid</code> variable based on the <code>raster</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">rasterToPolygons</span>(r) <span class="co"># Convert it to a `SpatialPolygonsDataFrame` object</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> grid[<span class="fu">as.vector</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid), <span class="at">nrow =</span> n_row, <span class="at">ncol =</span> n_col, <span class="at">byrow =</span> T)), ] <span class="co"># Rearrange the indices numbering</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>Y <span class="ot">&lt;-</span> grid<span class="sc">$</span>layer</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>cellarea <span class="ot">&lt;-</span> resolution <span class="sc">*</span> resolution</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Lastly, we just compute the intersection between <code>grid</code> and <code>map</code>. This can be done using the <code>raster::intersect()</code> function (from the <code>raster</code> package, as the namespace suggests).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>gridmap <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">intersect</span>(<span class="at">x =</span> grid, <span class="at">y =</span> map) <span class="co"># Compute the intersection between `grid` and `map`</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> grid[grid<span class="sc">$</span>id <span class="sc">%in%</span> gridmap<span class="sc">$</span>id, ]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(grid)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map, <span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Object of class SpatialPolygonsDataFrame
Coordinates:
     min    max
x 343.45 366.45
y 410.29 431.79
Is projected: NA 
proj4string : [NA]
Data attributes:
     layer               id               Y              cellarea   
 Min.   : 0.0000   Min.   :  10.0   Min.   : 0.0000   Min.   :0.25  
 1st Qu.: 0.0000   1st Qu.: 658.8   1st Qu.: 0.0000   1st Qu.:0.25  
 Median : 0.0000   Median :1110.5   Median : 0.0000   Median :0.25  
 Mean   : 0.7128   Mean   :1072.8   Mean   : 0.7128   Mean   :0.25  
 3rd Qu.: 0.0000   3rd Qu.:1485.2   3rd Qu.: 0.0000   3rd Qu.:0.25  
 Max.   :19.0000   Max.   :1971.0   Max.   :19.0000   Max.   :0.25  </code></pre>
</div>
</div>
<p>Now that we have prepared all the data, we can fit the model using <code>R-INLA</code>. To do so, we have to specify a <code>formula</code> and fit the model using the <code>inla()</code> function. For reference, check <code>inla.doc("matern2d")</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change prior of the precision parameter from (1 / sigma^2) ~ Gamma(1, 0.0005) for PC prior for sigma</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Prob(sigma &gt; u) = alpha</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>prior.list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pc.prec"</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.01</span>))) <span class="co"># c(u, alpha)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id, <span class="at">model =</span> <span class="st">"matern2d"</span>, <span class="at">nrow =</span> n_row, <span class="at">ncol =</span> n_col, <span class="at">nu =</span> <span class="dv">1</span>, <span class="at">hyper =</span> prior.list) <span class="co"># Intercept + Matérn spatial random effects</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">"poisson"</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> grid<span class="sc">@</span>data,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">E =</span> cellarea) <span class="co"># Acts like an offset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 1.74, Running = 4.91, Post = 0.0908, Total = 6.74 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -2.106 0.422     -3.013    -2.08     -1.351 -2.018   0

Random effects:
  Name    Model
    id Matern2D model

Model hyperparameters:
                  mean    sd 0.025quant 0.5quant 0.975quant  mode
Precision for id 0.246 0.027      0.195    0.246       0.30 0.247
Range for id     5.792 0.509      4.893    5.757       6.89 5.661

Marginal log-Likelihood:  -1073.43 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>Now, we can plot the random effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>R.E. <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.random<span class="sc">$</span>id[grid<span class="sc">$</span>id, <span class="st">"mean"</span>]</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>gridborder <span class="ot">&lt;-</span> <span class="fu">gUnaryUnion</span>(grid) <span class="co"># Plot the random effects using `tmap` package</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(grid) <span class="sc">+</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="fu">c</span>(<span class="st">"R.E."</span>), <span class="at">style =</span> <span class="st">"cont"</span>, <span class="at">border.col =</span> <span class="st">"transparent"</span>, <span class="at">midpoint =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(gridborder) <span class="sc">+</span> </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>)) <span class="sc">+</span> <span class="fu">tm_layout</span>(<span class="at">fontfamily =</span> <span class="st">"LM Roman 10"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From the above map, we <strong>observe a non-constant pattern of the spatially structured random effect suggesting that the intensity of the process that generates the cancer-diagnosed patients’ locations may be affected by other spatial factors that have not been considered in the model</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>cellarea   <span class="ot">&lt;-</span> resolution <span class="sc">*</span> resolution</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>Mean  <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>] <span class="sc">*</span> cellarea</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>Lower <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"0.025quant"</span>] <span class="sc">*</span> cellarea</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>Upper <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"0.975quant"</span>] <span class="sc">*</span> cellarea</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Changing the margin size to accommodate the plot caption</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>bbox_new <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(grid)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>xrange <span class="ot">&lt;-</span> bbox_new<span class="sc">$</span>xmax <span class="sc">-</span> bbox_new<span class="sc">$</span>xmin <span class="co"># range of x values</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>yrange <span class="ot">&lt;-</span> bbox_new<span class="sc">$</span>ymax <span class="sc">-</span> bbox_new<span class="sc">$</span>ymin <span class="co"># range of y values</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>bbox_new[<span class="dv">1</span>] <span class="ot">&lt;-</span> bbox_new[<span class="dv">1</span>] <span class="sc">-</span> (<span class="fl">0.25</span> <span class="sc">*</span> xrange)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>bbox_new    <span class="ot">&lt;-</span> bbox_new <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Main plot for the estimated intensity (along with a 95% equal-tail credible interval)</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(grid, <span class="at">bbox =</span> bbox_new) <span class="sc">+</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="fu">c</span>(<span class="st">"Lower"</span>, <span class="st">"Mean"</span>, <span class="st">"Upper"</span>),</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">style =</span> <span class="st">'fixed'</span>, <span class="at">border.col =</span> <span class="st">"transparent"</span>,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1.0</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="fu">ceiling</span>(<span class="fu">max</span>(grid<span class="sc">$</span>Upper)) <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(gridborder) <span class="sc">+</span> </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>)) <span class="sc">+</span> </span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">fontfamily =</span> <span class="st">"LM Roman 10"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">inner.margins  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From the above plot, we can identify (while also accounting for the estimating uncertainty) the areas with high incidence of lung-cancer patients (denoted by the estimated intensity process). Based on such information, policymakers can focus their resources on regions that matter the most when dealing with cancer management.</p>
<hr>
<p>We can also include a temporal random effect in the <code>R-INLA</code> <code>formula</code> (e.g., <code>f(id_time, model = "ar1")</code>), with possibly space-time interaction terms (<a href="https://onlinelibrary.wiley.com/doi/10.1002/1097-0258%2820000915/30%2919%3A17/18%3C2555%3A%3AAID-SIM587%3E3.0.CO%3B2-%23">Held, 2000</a>). That is precisely what we will do in our next example.</p>
<hr>
</section>
<section id="example-2" class="level4">
<h4 class="anchored" data-anchor-id="example-2">Example 2</h4>
<p>For this example, we will analyze the location of terrorism attacks in a given country over the years. The two data objects (<code>terror_country.rds</code> and <code>area_country.rds</code>) can be downloaded from <a href="https://avramaral.github.io/PP_inference/terror_country.rds">here</a> and <a href="https://avramaral.github.io/PP_inference/area_country.rds">here</a>, respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>terror_country <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"terror_country.rds"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(terror_country<span class="sc">$</span>country)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  AFG   AGO   ALB   ARE   ARG   ARM   AUS   AUT   AZE   BDI   BEL   BFA   BGD 
 4783     1     6     4    13     5    33     5     4   204     9    17   813 
  BGR   BIH   BLR   BRA   CAF   CAN   CHE   CHL   CHN   CIV   CMR   COD   COG 
   11     9     6    10   112    22     5    40    54    31   118   353     2 
  COL   CYP   CZE   DEU   DOM   DZA   ECU   EGY   ERI   ESP   EST   ETH   FIN 
  659    13    14   126     1   169     6   550    16    17     3    31    10 
  FRA   GBR   GEO   GHA   GIN   GNB   GRC   GTM   GUY   HND   HRV   HTI   HUN 
  106   330    20     2     4     2   217     4     1     4     5     1     3 
  IDN   IND   IRL   IRN   IRQ   ISL   ISR   ITA   JAM   JOR   JPN   KAZ   KEN 
  125  4190   133    61 15022     2   324    49     1    14    16    16   279 
  KGZ   KHM   KOR   KWT   LAO   LBN   LBR   LBY   LKA   MAR   MDA   MDG   MEX 
   10     2     2     3     2   219     2  1156    19     2     2     6    48 
  MKD   MLI   MMR   MNE   MOZ   MRT   MWI   MYS   NER   NGA   NIC   NLD   NOR 
    7   278   108     3    88     2     1    36    86  2458     1    12     4 
  NPL   NZL   PAK   PAN   PER   PHL   POL   PRT   PRY   PSE   QAT   RUS   RWA 
  224     2  8116     1    22  2328     2     2    49   527     1   707    26 
  SAU   SDN   SEN   SLE   SOM   SSD   SVK   SWE   SWZ   SYR   TCD   THA   TJK 
  153   381    10     1  2087   120     1    52     1  1398    26  1039     8 
  TKM   TTO   TUN   TUR   TWN   TZA   UGA   UKR   URY   USA   UZB   VEN   YEM 
    7     3    61   651     2    19    32  1373     1   188     1    14  1712 
  YUG   ZAF   ZWE 
   28    61     5 </code></pre>
</div>
</div>
<p>Aiming to have a larger data set, we analyze the country with the highest number of observed events, i.e., <code>IRQ</code>. Also, we will analyze observed events that occurred from 2010 to 2015.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>country_code <span class="ot">&lt;-</span> <span class="st">"IRQ"</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>terror_country <span class="ot">&lt;-</span> terror_country[terror_country<span class="sc">$</span>country <span class="sc">==</span> country_code, ]</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>terror_country <span class="ot">&lt;-</span> terror_country[(terror_country<span class="sc">$</span>iyear <span class="sc">&gt;=</span> <span class="dv">2010</span>) <span class="sc">&amp;</span> (terror_country<span class="sc">$</span>iyear <span class="sc">&lt;=</span> <span class="dv">2015</span>), ] </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(terror_country) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(terror_country) <span class="ot">&lt;-</span> <span class="st">"+proj=longlat"</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>area_country <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"area_country.rds"</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>area_country <span class="ot">&lt;-</span> area_country[area_country<span class="sc">$</span>sov_a3 <span class="sc">==</span> country_code, ]</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>area_country <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(<span class="at">x =</span> area_country, <span class="at">CRSobj =</span> <span class="fu">CRS</span>(<span class="st">"+proj=longlat"</span>))</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(area_country, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(terror_country, <span class="at">add =</span> T, <span class="at">col =</span> <span class="st">"green"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, given a partition, we can do as before, and count the number of events in each cell. However, notice that we also have to account for the variable year when doing so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>resolution <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">raster</span>(area_country, <span class="at">resolution =</span> resolution) </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>(n_row <span class="ot">&lt;-</span> <span class="fu">nrow</span>(r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(n_col <span class="ot">&lt;-</span> <span class="fu">ncol</span>(r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>terror_country<span class="sc">$</span>year <span class="ot">&lt;-</span> terror_country<span class="sc">$</span>iyear <span class="sc">-</span> <span class="fu">min</span>(terror_country<span class="sc">$</span>iyear) <span class="sc">+</span> <span class="dv">1</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n_years <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(terror_country<span class="sc">$</span>year))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>ras <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>grids <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>grids_map <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">6</span>) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_years) {</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  tab[[y]] <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">cellFromXY</span>(r, terror_country[terror_country<span class="sc">$</span>year <span class="sc">==</span> y, ]))</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  ras[[y]] <span class="ot">&lt;-</span> r</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  ras[[y]][<span class="fu">as.numeric</span>(<span class="fu">names</span>(tab[[y]]))] <span class="ot">&lt;-</span> tab[[y]]</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">values</span>(ras[[y]])[<span class="fu">is.na</span>(<span class="fu">values</span>(ras[[y]]))] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  grids[[y]] <span class="ot">&lt;-</span> <span class="fu">rasterToPolygons</span>(ras[[y]]) </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  grids[[y]] <span class="ot">&lt;-</span> grids[[y]][<span class="fu">as.vector</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grids[[y]]), <span class="at">nrow =</span> n_row, <span class="at">ncol =</span> n_col, <span class="at">byrow =</span> T)), ] </span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  grids[[y]]<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grids[[y]])</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  grids[[y]]<span class="sc">$</span>Y <span class="ot">&lt;-</span> grids[[y]]<span class="sc">$</span>layer</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  grids[[y]]<span class="sc">$</span>cellarea <span class="ot">&lt;-</span> resolution <span class="sc">*</span> resolution</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  grids_map[[y]] <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">intersect</span>(<span class="at">x =</span> grids[[y]], <span class="at">y =</span> area_country) </span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  grids[[y]] <span class="ot">&lt;-</span> grids[[y]][grids[[y]]<span class="sc">$</span>id <span class="sc">%in%</span> grids_map[[y]]<span class="sc">$</span>id, ]</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(ras[[y]], <span class="at">main =</span> y)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(area_country, <span class="at">add =</span> T)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can create a data object with the extra id_time index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_years) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (y <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    data_inla <span class="ot">&lt;-</span> grids[[y]]<span class="sc">@</span>data</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    data_inla <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_inla, grids[[y]]<span class="sc">@</span>data)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>data_inla <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data_inla, <span class="at">id_time =</span> <span class="fu">rep</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>n_years, <span class="at">each =</span> <span class="fu">nrow</span>(grids[[<span class="dv">1</span>]])))</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>data_inla[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ((<span class="fu">nrow</span>(data_inla) <span class="sc">-</span> <span class="dv">2</span>)<span class="sc">:</span><span class="fu">nrow</span>(data_inla))), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     layer  id Y cellarea id_time
141      0   8 0     0.25       1
161      0   9 0     0.25       1
181      0  10 0     0.25       1
2795     2 320 2     0.25       6
2995     1 321 1     0.25       6
3005     0 338 0     0.25       6</code></pre>
</div>
</div>
<p>Finally, we can fit the model. In our case, we will define <span class="math display">\begin{align*}
\zeta(x, t) = \zeta_1(x) + \zeta_2(t),
\end{align*}</span> where <span class="math inline">\zeta_1(x)</span> is a spatial model (e.g., Matérn) and <span class="math inline">\zeta_2(t)</span> is a temporal model (e.g., AR1).</p>
<p>Alternatively, we could fit a model with interaction. For example, for <span class="math inline">x_i \in \mathcal{D}</span>, <span class="math display">\begin{align*}
\zeta(x_i, t) = \alpha \zeta(x_i, t - 1) + \phi(x_i, t)
\end{align*}</span> where <span class="math inline">|\alpha| &lt; 1</span> and <span class="math inline">\zeta(x, 1)</span> follows a stationary distribution of a first-order autoregressive process (AR1), namely <span class="math inline">\text{Normal}(0, \sigma^2_{\omega}/(1 - \alpha^2))</span>. And each <span class="math inline">\phi(x, t)</span> follows a zero-mean Gaussian distribution temporally independent but spatially dependent at each time. In general, from <a href="https://onlinelibrary.wiley.com/doi/10.1002/1097-0258%2820000915/30%2919%3A17/18%3C2555%3A%3AAID-SIM587%3E3.0.CO%3B2-%23">Held, 2000</a>,</p>
<p><img src="./inter_types.png" class="img-fluid"></p>
<p>Getting back to the chosen model, we have</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>prior.list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pc.prec"</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.01</span>))) <span class="co"># Priors</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Separable space-temporal model: eta_ij = beta_0 + u_i + v_j</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> Y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">f</span>(id, </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">"matern2d"</span>, </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nrow =</span> n_row, </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ncol =</span> n_col, </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nu =</span> <span class="dv">1</span>, </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">hyper =</span> prior.list) <span class="sc">+</span> <span class="fu">f</span>(id_time, <span class="at">model =</span> <span class="st">"ar1"</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with interaction: eta_ij = beta_0 + u_ij</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co"># formula &lt;- Y ~ 1 + f(id, </span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                      model = "matern2d", </span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                      nrow = n_row, </span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                      ncol = n_col, </span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                      nu = 1, </span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                      group = id_time,</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                      control.group = list(model = "ar1"),</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co">#                      hyper = prior.list)</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">"poisson"</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> data_inla,</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">E =</span> resolution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " keep = keep, working.directory = working.directory, 
   silent = silent, ", " inla.mode = inla.mode, safe = FALSE, debug = 
   debug, .parent.frame = .parent.frame)" ) 
Time used:
    Pre = 2.12, Running = 1.76, Post = 0.062, Total = 3.94 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -2.786 0.611     -4.033   -2.769      -1.63 -2.768   0

Random effects:
  Name    Model
    id Matern2D model
   id_time AR1 model

Model hyperparameters:
                       mean    sd 0.025quant 0.5quant 0.975quant  mode
Precision for id      0.164 0.021      0.125    0.164      0.208 0.164
Range for id          2.836 0.288      2.317    2.819      3.452 2.782
Precision for id_time 8.147 2.760      4.044    7.712     14.776 6.911
Rho for id_time       0.569 0.102      0.341    0.579      0.739 0.603

Marginal log-Likelihood:  -2303.43 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>astly, as in the previous example, we can plot the estimated intensity for all years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>grid       <span class="ot">&lt;-</span> grids[[<span class="dv">1</span>]]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>cells_grid <span class="ot">&lt;-</span> <span class="fu">nrow</span>(grids[[<span class="dv">1</span>]])</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>cellarea   <span class="ot">&lt;-</span> resolution <span class="sc">*</span> resolution</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M1 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][<span class="dv">1</span><span class="sc">:</span>cells_grid] <span class="sc">*</span> cellarea</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M2 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][(cells_grid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(cells_grid <span class="sc">*</span> <span class="dv">2</span>)] <span class="sc">*</span> cellarea</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M3 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][(cells_grid <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(cells_grid <span class="sc">*</span> <span class="dv">3</span>)] <span class="sc">*</span> cellarea</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M4 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][(cells_grid <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(cells_grid <span class="sc">*</span> <span class="dv">4</span>)] <span class="sc">*</span> cellarea</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M5 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][(cells_grid <span class="sc">*</span> <span class="dv">4</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(cells_grid <span class="sc">*</span> <span class="dv">5</span>)] <span class="sc">*</span> cellarea</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>M6 <span class="ot">&lt;-</span> res<span class="sc">$</span>summary.fitted.values[, <span class="st">"mean"</span>][(cells_grid <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(cells_grid <span class="sc">*</span> <span class="dv">6</span>)] <span class="sc">*</span> cellarea</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>max_int <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">c</span>(grid<span class="sc">$</span>M1, grid<span class="sc">$</span>M2, grid<span class="sc">$</span>M3, grid<span class="sc">$</span>M4, grid<span class="sc">$</span>M5, grid<span class="sc">$</span>M6)))</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>max_int <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(max_int <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">*</span> <span class="dv">10</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>bbox_new <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(grid)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>xrange <span class="ot">&lt;-</span> bbox_new<span class="sc">$</span>xmax <span class="sc">-</span> bbox_new<span class="sc">$</span>xmin <span class="co"># range of x values</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>yrange <span class="ot">&lt;-</span> bbox_new<span class="sc">$</span>ymax <span class="sc">-</span> bbox_new<span class="sc">$</span>ymin <span class="co"># range of y values</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>bbox_new[<span class="dv">1</span>] <span class="ot">&lt;-</span> bbox_new[<span class="dv">1</span>] <span class="sc">-</span> (<span class="fl">0.25</span> <span class="sc">*</span> xrange)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>bbox_new <span class="ot">&lt;-</span> bbox_new <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>gridborder <span class="ot">&lt;-</span> <span class="fu">gUnaryUnion</span>(grid) </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(grid, <span class="at">bbox =</span> bbox_new) <span class="sc">+</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="fu">c</span>(<span class="st">"M1"</span>, <span class="st">"M2"</span>, <span class="st">"M3"</span>, <span class="st">"M4"</span>, <span class="st">"M5"</span>, <span class="st">"M6"</span>),</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>              <span class="at">style =</span> <span class="st">'fixed'</span>, <span class="at">border.col =</span> <span class="st">"transparent"</span>,</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>              <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>, max_int)) <span class="sc">+</span> </span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(gridborder) <span class="sc">+</span> <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">tm_legend</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">fontfamily =</span> <span class="st">"LM Roman 10"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="1440"></p>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>